<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-translate="appTitle">Rapports Commerciaux</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#2196F3">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üìã</text></svg>">
    <link rel="stylesheet" href="css/styles.css">
</head>
<body>
    <!-- S√©lecteur de langue -->
    <div id="languageSelector"></div>

    <div class="container">
        <!-- HEADER -->
        <div class="header" id="header">
            <div class="user-info">
                <div class="avatar" id="userAvatar">U</div>
                <div>
                    <div id="userName">Utilisateur</div>
                    <div class="user-role" id="userRole">Commercial</div>
                </div>
            </div>
            <div class="nav-buttons">
                <button class="nav-btn" id="navBrouillon" data-translate="drafts">üìù Brouillons</button>
                <button class="nav-btn" id="navRapports" data-translate="reports">üìä Rapports</button>
                <button class="nav-btn logout" id="logoutBtn" data-translate="logout">üö™</button>
            </div>
        </div>

        <!-- MAIN CONTENT -->
        <div id="mainContent">
            
            <!-- PAGE LOGIN -->
            <div class="page login-page" id="loginPage" style="display: block;">
                <div class="logo">üè¢</div>
                <h1 data-translate="login">Connexion</h1>
                <form id="loginForm">
                    <div class="form-group">
                        <label for="username" data-translate="username">üë§ Nom d'utilisateur</label>
                        <input type="text" id="username" name="username" required autocomplete="username">
                    </div>
                    <div class="form-group">
                        <label for="password" data-translate="password">üîí Mot de passe</label>
                        <input type="password" id="password" name="password" required autocomplete="current-password">
                    </div>
                    <button type="submit" class="login-btn" id="loginBtn" data-translate="connect">Se connecter</button>
                    <div class="error-message" id="errorMessage"></div>
                    <div class="loading" id="loadingMessage">
                        <div class="loading-spinner"></div>
                        <span data-translate="loading">Connexion en cours...</span>
                    </div>
                </form>
            </div>

            <!-- PAGE BROUILLON -->
            <div class="page" id="brouillonPage" style="display: none;">
                <h1 data-translate="drafts">üìù Brouillons</h1>
                
                <!-- Section Enregistrement -->
                <div class="recording-section">
                    <h3 data-translate="recordNew">üé§ Cr√©er un nouveau rapport</h3>
                    
                    <!-- Options d'ajout -->
                    <div class="input-options">
                        <div class="option-group">
                            <h4 data-translate="recordVoice">Enregistrer un vocal</h4>
                            <div class="record-button" id="recordBtn">‚è∫Ô∏è</div>
                            <div id="recordingStatus" data-translate="pressToRecord">Appuyer pour enregistrer</div>
                            
                            <div class="audio-controls" id="audioControls">
                                <button class="audio-btn" id="playBtn" data-translate="listen">‚ñ∂Ô∏è √âcouter</button>
                                <button class="audio-btn" id="reRecordBtn" data-translate="redo">üîÑ Refaire</button>
                            </div>
                        </div>
                        
                        <div class="option-divider">OU</div>
                        
                        <div class="option-group">
                            <h4 data-translate="importFile">Importer un fichier audio</h4>
                            <input type="file" id="audioFileInput" accept="audio/*" style="display: none;">
                            <button class="upload-btn" id="uploadBtn" data-translate="chooseFile">üìÅ Choisir un fichier</button>
                            <div id="uploadStatus"></div>
                        </div>
                    </div>
                    
                    <button class="send-btn" id="sendAudioBtn" data-translate="sendForProcessing">üì§ Envoyer pour traitement</button>
                </div>

                <!-- Liste des brouillons -->
                <div>
                    <h3>üìã Rapports en attente de validation :</h3>
                    <div class="reports-list" id="brouillonsList">
                        <div class="empty-state">
                            <div class="icon">üìÑ</div>
                            <p data-translate="noDrafts">Aucun brouillon pour le moment</p>
                            <p class="empty-subtitle" data-translate="noDraftsSubtitle">Enregistrez ou importez votre premier rapport vocal !</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- PAGE RAPPORTS -->
            <div class="page" id="rapportsPage" style="display: none;">
                <h1 data-translate="reports">üìä Rapports finalis√©s</h1>
                
                <!-- Section Recherche -->
                <div class="search-section">
                    <input type="text" class="search-input" id="searchInput" data-translate="searchReport" placeholder="üîç Rechercher un rapport...">
                </div>

                <!-- Stats -->
                <div class="stats-section">
                    ‚úÖ <span data-translate="validatedReports">Rapports valid√©s</span> : <span id="rapportsCount">0</span>
                    üìÑ <span data-translate="generatedPDFs">PDF g√©n√©r√©s</span> : <span id="pdfCount">0</span>
                </div>

                <!-- Liste des rapports -->
                <div class="reports-list" id="rapportsList">
                    <div class="empty-state">
                        <div class="icon">üìã</div>
                        <p data-translate="noReports">Aucun rapport finalis√©</p>
                        <p class="empty-subtitle" data-translate="noReportsSubtitle">Validez vos brouillons pour les voir ici !</p>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <!-- Scripts dans le bon ordre -->
    <script src="js/config.js"></script>
    <script src="js/utils.js"></script>
    
    <!-- Gestionnaire de langue et Google Sheets optimis√© -->
    <script>
        // ===========================================
        // SYST√àME DE TRADUCTION MULTILINGUE
        // ===========================================

        class LanguageManager {
            constructor() {
                this.currentLanguage = this.detectUserLanguage();
                this.supportedLanguages = ['fr', 'en', 'ja'];
                this.translations = {
                    fr: {
                        appTitle: "Rapports Commerciaux",
                        login: "Connexion",
                        username: "Nom d'utilisateur",
                        password: "Mot de passe",
                        connect: "Se connecter",
                        logout: "D√©connexion",
                        loading: "Connexion en cours...",
                        welcome: "Bienvenue",
                        drafts: "Brouillons",
                        reports: "Rapports",
                        recordNew: "Cr√©er un nouveau rapport",
                        recordVoice: "Enregistrer un vocal",
                        importFile: "Importer un fichier audio",
                        pressToRecord: "Appuyer pour enregistrer",
                        recording: "Enregistrement en cours...",
                        recordingComplete: "Enregistrement termin√©",
                        listen: "√âcouter",
                        redo: "Refaire",
                        chooseFile: "Choisir un fichier",
                        sendForProcessing: "Envoyer pour traitement",
                        noDrafts: "Aucun brouillon pour le moment",
                        noDraftsSubtitle: "Enregistrez ou importez votre premier rapport vocal !",
                        noReports: "Aucun rapport finalis√©",
                        noReportsSubtitle: "Validez vos brouillons pour les voir ici !",
                        generating: "G√©n√©ration en cours...",
                        error: "Erreur",
                        success: "Succ√®s",
                        edit: "√âditer",
                        validate: "Valider",
                        delete: "Supprimer",
                        view: "Voir",
                        share: "Partager",
                        export: "Exporter",
                        downloadPDF: "T√©l√©charger PDF",
                        save: "Sauvegarder",
                        cancel: "Annuler",
                        fillAllFields: "Veuillez remplir tous les champs",
                        userNotFound: "Utilisateur introuvable",
                        wrongPassword: "Mot de passe incorrect",
                        accountSuspended: "Compte suspendu - Contactez l'administrateur pour r√©activer votre abonnement",
                        connectionError: "Erreur de connexion - V√©rifiez votre connexion internet",
                        validatedReports: "Rapports valid√©s",
                        generatedPDFs: "PDF g√©n√©r√©s",
                        searchReport: "Rechercher un rapport...",
                        editReport: "√âditer le rapport",
                        reportTitle: "Titre du rapport",
                        reportContent: "Contenu du rapport",
                        cacheUpdated: "Liste des utilisateurs mise √† jour",
                        cacheError: "Erreur lors de la mise √† jour",
                        syncInProgress: "Synchronisation en cours...",
                        syncComplete: "Synchronisation termin√©e"
                    },
                    en: {
                        appTitle: "Sales Reports",
                        login: "Login",
                        username: "Username",
                        password: "Password",
                        connect: "Log in",
                        logout: "Logout",
                        loading: "Logging in...",
                        welcome: "Welcome",
                        drafts: "Drafts",
                        reports: "Reports",
                        recordNew: "Create a new report",
                        recordVoice: "Record voice",
                        importFile: "Import audio file",
                        pressToRecord: "Press to record",
                        recording: "Recording in progress...",
                        recordingComplete: "Recording complete",
                        listen: "Listen",
                        redo: "Redo",
                        chooseFile: "Choose file",
                        sendForProcessing: "Send for processing",
                        noDrafts: "No drafts at the moment",
                        noDraftsSubtitle: "Record or import your first voice report!",
                        noReports: "No finalized reports",
                        noReportsSubtitle: "Validate your drafts to see them here!",
                        generating: "Generating...",
                        error: "Error",
                        success: "Success",
                        edit: "Edit",
                        validate: "Validate",
                        delete: "Delete",
                        view: "View",
                        share: "Share",
                        export: "Export",
                        downloadPDF: "Download PDF",
                        save: "Save",
                        cancel: "Cancel",
                        fillAllFields: "Please fill in all fields",
                        userNotFound: "User not found",
                        wrongPassword: "Incorrect password",
                        accountSuspended: "Account suspended - Contact administrator to reactivate your subscription",
                        connectionError: "Connection error - Check your internet connection",
                        validatedReports: "Validated reports",
                        generatedPDFs: "Generated PDFs",
                        searchReport: "Search for a report...",
                        editReport: "Edit report",
                        reportTitle: "Report title",
                        reportContent: "Report content",
                        cacheUpdated: "User list updated",
                        cacheError: "Update error",
                        syncInProgress: "Synchronizing...",
                        syncComplete: "Synchronization complete"
                    },
                    ja: {
                        appTitle: "Âñ∂Ê•≠„É¨„Éù„Éº„Éà",
                        login: "„É≠„Ç∞„Ç§„É≥",
                        username: "„É¶„Éº„Ç∂„ÉºÂêç",
                        password: "„Éë„Çπ„ÉØ„Éº„Éâ",
                        connect: "„É≠„Ç∞„Ç§„É≥",
                        logout: "„É≠„Ç∞„Ç¢„Ç¶„Éà",
                        loading: "„É≠„Ç∞„Ç§„É≥‰∏≠...",
                        welcome: "„Çà„ÅÜ„Åì„Åù",
                        drafts: "‰∏ãÊõ∏„Åç",
                        reports: "„É¨„Éù„Éº„Éà",
                        recordNew: "Êñ∞„Åó„ÅÑ„É¨„Éù„Éº„Éà„Çí‰ΩúÊàê",
                        recordVoice: "Èü≥Â£∞„ÇíÈå≤Èü≥",
                        importFile: "„Ç™„Éº„Éá„Ç£„Ç™„Éï„Ç°„Ç§„É´„Çí„Ç§„É≥„Éù„Éº„Éà",
                        pressToRecord: "Èå≤Èü≥„Åô„Çã„Å´„ÅØÊäº„Åó„Å¶„Åè„Å†„Åï„ÅÑ",
                        recording: "Èå≤Èü≥‰∏≠...",
                        recordingComplete: "Èå≤Èü≥ÂÆå‰∫Ü",
                        listen: "ËÅû„Åè",
                        redo: "„ÇÑ„ÇäÁõ¥„Åó",
                        chooseFile: "„Éï„Ç°„Ç§„É´„ÇíÈÅ∏Êäû",
                        sendForProcessing: "Âá¶ÁêÜ„ÅÆ„Åü„ÇÅ„Å´ÈÄÅ‰ø°",
                        noDrafts: "ÁèæÂú®‰∏ãÊõ∏„Åç„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì",
                        noDraftsSubtitle: "ÊúÄÂàù„ÅÆÈü≥Â£∞„É¨„Éù„Éº„Éà„ÇíÈå≤Èü≥„Åæ„Åü„ÅØ„Ç§„É≥„Éù„Éº„Éà„Åó„Å¶„Åè„Å†„Åï„ÅÑÔºÅ",
                        noReports: "ÂÆåÊàê„Åó„Åü„É¨„Éù„Éº„Éà„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì",
                        noReportsSubtitle: "‰∏ãÊõ∏„Åç„ÇíÊâøË™ç„Åó„Å¶„Åì„Åì„Å´Ë°®Á§∫„Åï„Åõ„Å¶„Åè„Å†„Åï„ÅÑÔºÅ",
                        generating: "ÁîüÊàê‰∏≠...",
                        error: "„Ç®„É©„Éº",
                        success: "ÊàêÂäü",
                        edit: "Á∑®ÈõÜ",
                        validate: "ÊâøË™ç",
                        delete: "ÂâäÈô§",
                        view: "Ë°®Á§∫",
                        share: "ÂÖ±Êúâ",
                        export: "„Ç®„ÇØ„Çπ„Éù„Éº„Éà",
                        downloadPDF: "PDF„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ",
                        save: "‰øùÂ≠ò",
                        cancel: "„Ç≠„É£„É≥„Çª„É´",
                        fillAllFields: "„Åô„Åπ„Å¶„ÅÆ„Éï„Ç£„Éº„É´„Éâ„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ",
                        userNotFound: "„É¶„Éº„Ç∂„Éº„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì",
                        wrongPassword: "„Éë„Çπ„ÉØ„Éº„Éâ„ÅåÊ≠£„Åó„Åè„ÅÇ„Çä„Åæ„Åõ„Çì",
                        accountSuspended: "„Ç¢„Ç´„Ç¶„É≥„Éà„ÅåÂÅúÊ≠¢„Åï„Çå„Å¶„ÅÑ„Åæ„Åô - „Çµ„Éñ„Çπ„ÇØ„É™„Éó„Ç∑„Éß„É≥„ÅÆÂÜçÈñã„Å´„Å§„ÅÑ„Å¶ÁÆ°ÁêÜËÄÖ„Å´„ÅäÂïè„ÅÑÂêà„Çè„Åõ„Åè„Å†„Åï„ÅÑ",
                        connectionError: "Êé•Á∂ö„Ç®„É©„Éº - „Ç§„É≥„Çø„Éº„Éç„ÉÉ„ÉàÊé•Á∂ö„ÇíÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ",
                        validatedReports: "ÊâøË™ç„Åï„Çå„Åü„É¨„Éù„Éº„Éà",
                        generatedPDFs: "ÁîüÊàê„Åï„Çå„ÅüPDF",
                        searchReport: "„É¨„Éù„Éº„Éà„ÇíÊ§úÁ¥¢...",
                        editReport: "„É¨„Éù„Éº„Éà„ÇíÁ∑®ÈõÜ",
                        reportTitle: "„É¨„Éù„Éº„Éà„ÅÆ„Çø„Ç§„Éà„É´",
                        reportContent: "„É¨„Éù„Éº„Éà„ÅÆÂÜÖÂÆπ",
                        cacheUpdated: "„É¶„Éº„Ç∂„Éº„É™„Çπ„Éà„ÅåÊõ¥Êñ∞„Åï„Çå„Åæ„Åó„Åü",
                        cacheError: "Êõ¥Êñ∞„Ç®„É©„Éº",
                        syncInProgress: "ÂêåÊúü‰∏≠...",
                        syncComplete: "ÂêåÊúüÂÆå‰∫Ü"
                    }
                };
            }

            detectUserLanguage() {
                const saved = localStorage.getItem('app_language');
                if (saved && this.supportedLanguages.includes(saved)) {
                    return saved;
                }
                
                const browserLang = navigator.language.substring(0, 2);
                return this.supportedLanguages.includes(browserLang) ? browserLang : 'fr';
            }

            setLanguage(lang) {
                if (this.supportedLanguages.includes(lang)) {
                    this.currentLanguage = lang;
                    localStorage.setItem('app_language', lang);
                    this.updateUI();
                    return true;
                }
                return false;
            }

            t(key) {
                return this.translations[this.currentLanguage][key] || this.translations['fr'][key] || key;
            }

            getCurrentLanguage() {
                return this.currentLanguage;
            }

            getSupportedLanguages() {
                return this.supportedLanguages.map(lang => ({
                    code: lang,
                    name: {
                        'fr': 'Fran√ßais',
                        'en': 'English', 
                        'ja': 'Êó•Êú¨Ë™û'
                    }[lang]
                }));
            }

            updateUI() {
                const elements = document.querySelectorAll('[data-translate]');
                elements.forEach(el => {
                    const key = el.getAttribute('data-translate');
                    if (el.placeholder !== undefined) {
                        el.placeholder = this.t(key);
                    } else {
                        el.textContent = this.t(key);
                    }
                });

                window.dispatchEvent(new CustomEvent('languageChanged', {
                    detail: { language: this.currentLanguage }
                }));
            }

            createLanguageSelector() {
                const selector = document.createElement('div');
                selector.className = 'language-selector';
                selector.innerHTML = `
                    <select id="languageSelect" class="language-select">
                        ${this.getSupportedLanguages().map(lang => 
                            `<option value="${lang.code}" ${lang.code === this.currentLanguage ? 'selected' : ''}>${lang.name}</option>`
                        ).join('')}
                    </select>
                `;

                const select = selector.querySelector('#languageSelect');
                select.addEventListener('change', (e) => {
                    this.setLanguage(e.target.value);
                    if (typeof Utils !== 'undefined') {
                        Utils.showToast(this.t('cacheUpdated'), 'success');
                    }
                });

                return selector;
            }
        }

        // ===========================================
        // GOOGLE SHEETS MANAGER OPTIMIS√â
        // ===========================================

        class OptimizedGoogleSheetsManager {
            constructor() {
                this.SHEET_ID = '1f2SdNqwV83bU-h3OoVvkJPRm2WnJpPqPz7r3KML9KE';
                this.SHEET_NAME = 'Feuille1'; // Remis √† "Feuille1" au lieu de "Feuille 1"
                this.cache = {
                    users: [],
                    lastUpdate: null,
                    cacheDuration: 300000, // 5 minutes
                    retryCount: 3,
                    retryDelay: 1000
                };
                // Important: r√©f√©rence au gestionnaire de langue apr√®s initialisation
                this.lang = null;
            }

            // Nouvelle m√©thode pour initialiser la r√©f√©rence de langue
            initLanguageManager() {
                this.lang = window.languageManager || { t: (key) => key };
            }

            getSheetUrl() {
                return `https://docs.google.com/spreadsheets/d/${this.SHEET_ID}/gviz/tq?tqx=out:json&sheet=${this.SHEET_NAME}`;
            }

            async fetchUsersWithRetry(attempt = 1, showProgress = true) {
                // S'assurer que le gestionnaire de langue est initialis√©
                if (!this.lang) this.initLanguageManager();

                if (showProgress && attempt === 1 && typeof Utils !== 'undefined') {
                    Utils.showToast(this.lang.t('syncInProgress'), 'info', 5000);
                }

                try {
                    console.log(`üîÑ Tentative ${attempt}/${this.cache.retryCount} - R√©cup√©ration Google Sheets`);
                    
                    const controller = new AbortController();
                    const timeoutId = setTimeout(() => controller.abort(), 10000);
                    
                    const response = await fetch(this.getSheetUrl(), {
                        signal: controller.signal,
                        cache: 'no-cache'
                    });
                    
                    clearTimeout(timeoutId);
                    
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    
                    const textData = await response.text();
                    const jsonData = textData.substring(47).slice(0, -2);
                    const data = JSON.parse(jsonData);
                    
                    const users = this.parseSheetData(data);
                    
                    this.cache.users = users;
                    this.cache.lastUpdate = new Date();
                    
                    console.log(`‚úÖ ${users.length} utilisateurs r√©cup√©r√©s (tentative ${attempt})`);
                    
                    if (showProgress && typeof Utils !== 'undefined') {
                        Utils.showToast(this.lang.t('syncComplete'), 'success');
                    }
                    
                    return users;
                    
                } catch (error) {
                    console.error(`‚ùå Erreur tentative ${attempt}:`, error);
                    
                    if (attempt < this.cache.retryCount) {
                        const delay = this.cache.retryDelay * Math.pow(2, attempt - 1);
                        console.log(`‚è≥ Retry dans ${delay}ms...`);
                        
                        if (showProgress && typeof Utils !== 'undefined') {
                            Utils.showToast(`${this.lang.t('error')} - Retry ${attempt + 1}/${this.cache.retryCount}`, 'error', 2000);
                        }
                        
                        await new Promise(resolve => setTimeout(resolve, delay));
                        return this.fetchUsersWithRetry(attempt + 1, showProgress);
                    }
                    
                    console.error(`‚ùå √âchec d√©finitif apr√®s ${this.cache.retryCount} tentatives`);
                    
                    if (showProgress && typeof Utils !== 'undefined') {
                        Utils.showToast(this.lang.t('connectionError'), 'error');
                    }
                    
                    throw error;
                }
            }

            parseSheetData(data) {
                const users = [];
                
                if (!data.table || !data.table.rows) {
                    console.warn('‚ö†Ô∏è Aucune donn√©e trouv√©e dans Google Sheets');
                    return users;
                }
                
                const rows = data.table.rows;
                
                for (let i = 1; i < rows.length; i++) {
                    const row = rows[i];
                    
                    if (!row.c || row.c.length < 5) continue;
                    
                    try {
                        const user = {
                            id: i,
                            username: this.getCellValue(row.c[0]),
                            password: this.getCellValue(row.c[1]),
                            nom: this.getCellValue(row.c[2]),
                            role: this.getCellValue(row.c[3]),
                            statut: this.getCellValue(row.c[4]),
                            dateCreation: this.getCellValue(row.c[5]),
                            deviceId: this.getCellValue(row.c[6]),
                            derniereConnexion: this.getCellValue(row.c[7]),
                            isActive: this.getCellValue(row.c[4]) === 'actif'
                        };
                        
                        if (user.username && user.password) {
                            users.push(user);
                            console.log(`üë§ ${user.username} (${user.statut})`);
                        }
                        
                    } catch (error) {
                        console.error(`‚ùå Erreur parsing ligne ${i}:`, error);
                    }
                }
                
                return users;
            }

            getCellValue(cell) {
                if (!cell) return null;
                if (cell.v !== undefined) return cell.v;
                if (cell.f !== undefined) return cell.f;
                return null;
            }

            getDefaultUsers() {
                return [
                    {
                        id: 1,
                        username: "commercial1",
                        password: "pass123",
                        nom: "Jean Dupont",
                        role: "commercial",
                        statut: "inactif",
                        deviceId: null,
                        isActive: false,
                        dateCreation: "2024-09-23"
                    },
                    {
                        id: 2,
                        username: "andreac",
                        password: "pass123",
                        nom: "Andrea Ciechels",
                        role: "commercial",
                        statut: "actif",
                        deviceId: null,
                        isActive: true,
                        dateCreation: "2024-09-24"
                    },
                    {
                        id: 3,
                        username: "cocolocow",
                        password: "pass123",
                        nom: "Corentin Havouis",
                        role: "commercial",
                        statut: "actif",
                        deviceId: null,
                        isActive: true,
                        dateCreation: "2024-09-24"
                    },
                    {
                        id: 4,
                        username: "arthurf",
                        password: "pass123",
                        nom: "Arthur Fremion",
                        role: "commercial",
                        statut: "actif",
                        deviceId: null,
                        isActive: true,
                        dateCreation: "2024-09-24"
                    }
                ];
            }

            async getUsers(forceRefresh = false, showProgress = false) {
                if (!this.lang) this.initLanguageManager();

                if (!forceRefresh && this.cache.users.length > 0 && this.cache.lastUpdate) {
                    const timeDiff = new Date() - this.cache.lastUpdate;
                    if (timeDiff < this.cache.cacheDuration) {
                        console.log('üîÑ Cache m√©moire utilis√©');
                        return this.cache.users;
                    }
                }
                
                try {
                    return await this.fetchUsersWithRetry(1, showProgress);
                } catch (error) {
                    console.log('üîÑ Utilisation des utilisateurs par d√©faut');
                    if (typeof Utils !== 'undefined') {
                        Utils.showToast('Mode hors-ligne - Utilisateurs par d√©faut', 'error');
                    }
                    return this.getDefaultUsers();
                }
            }

            async findUser(username) {
                const users = await this.getUsers();
                return users.find(user => user.username === username);
            }

            async authenticateUser(username, password) {
                if (!this.lang) this.initLanguageManager();

                try {
                    console.log(`üîê Authentification: ${username}`);
                    
                    const user = await this.findUser(username);
                    
                    if (!user) {
                        return { 
                            success: false, 
                            error: this.lang.t('userNotFound')
                        };
                    }
                    
                    if (user.password !== password) {
                        return { 
                            success: false, 
                            error: this.lang.t('wrongPassword')
                        };
                    }
                    
                    if (!user.isActive || user.statut !== 'actif') {
                        return { 
                            success: false, 
                            error: this.lang.t('accountSuspended')
                        };
                    }
                    
                    console.log(`‚úÖ Authentification r√©ussie: ${username}`);
                    return { success: true, user: user };
                    
                } catch (error) {
                    console.error('‚ùå Erreur authentification:', error);
                    return { 
                        success: false, 
                        error: this.lang.t('connectionError')
                    };
                }
            }

            async updateUserDeviceId(username, deviceId) {
                console.log(`üì± Association device ${deviceId} √† ${username}`);
                const users = await this.getUsers();
                const user = users.find(u => u.username === username);
                if (user) {
                    user.deviceId = deviceId;
                    return true;
                }
                return false;
            }

            async updateLastConnection(username) {
                console.log(`‚è∞ Mise √† jour connexion: ${username}`);
                const users = await this.getUsers();
                const user = users.find(u => u.username === username);
                if (user) {
                    user.derniereConnexion = new Date().toISOString();
                    return true;
                }
                return false;
            }

            async refreshCache() {
                console.log('üîÑ Actualisation forc√©e du cache');
                return await this.getUsers(true, true);
            }

            async getUserStats() {
                const users = await this.getUsers();
                return {
                    total: users.length,
                    actifs: users.filter(u => u.isActive).length,
                    inactifs: users.filter(u => !u.isActive).length,
                    commerciaux: users.filter(u => u.role === 'commercial').length,
                    managers: users.filter(u => u.role === 'manager').length
                };
            }
        }

        // ===========================================
        // STYLES CSS POUR S√âLECTEUR DE LANGUE
        // ===========================================

        const languageSelectorStyles = `
        .language-selector {
            position: fixed;
            top: 10px;
            right: 10px;
            z-index: 1000;
        }

        .language-select {
            background: rgba(255, 255, 255, 0.95);
            border: 2px solid #2196F3;
            border-radius: 8px;
            padding: 5px 10px;
            font-size: 12px;
            cursor: pointer;
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
        }

        .language-select:hover {
            background: white;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .language-select:focus {
            outline: none;
            border-color: #1976D2;
        }
        `;

        const styleSheet = document.createElement('style');
        styleSheet.textContent = languageSelectorStyles;
        document.head.appendChild(styleSheet);

        // ===========================================
        // INITIALISATION GLOBALE
        // ===========================================

        // Initialisation imm√©diate du gestionnaire de langue
        window.languageManager = new LanguageManager();

        // Remplacement du gestionnaire Google Sheets
        window.GoogleSheetsManager = OptimizedGoogleSheetsManager;
    </script>
    
    <script src="js/audio-manager.js"></script>
    <script src="js/data-manager.js"></script>
    <script src="js/app.js"></script>
    
    <!-- Initialisation du s√©lecteur de langue -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            console.log('=== INITIALISATION APPLICATION ===');
            
            // V√©rifier que tous les scripts sont charg√©s
            if (typeof CONFIG === 'undefined') {
                console.error('CONFIG manquant');
                return;
            }
            if (typeof Utils === 'undefined') {
                console.error('Utils manquant');
                return;
            }
            
            // Initialiser le gestionnaire de langue s'il n'existe pas d√©j√†
            if (!window.languageManager) {
                window.languageManager = new LanguageManager();
            }
            
            // Ajouter le s√©lecteur de langue
            const languageSelector = document.getElementById('languageSelector');
            if (languageSelector && window.languageManager) {
                languageSelector.appendChild(window.languageManager.createLanguageSelector());
                window.languageManager.updateUI();
            }
            
            // √âcouter les changements de langue
            window.addEventListener('languageChanged', function(event) {
                console.log('Langue chang√©e vers:', event.detail.language);
                document.documentElement.lang = event.detail.language;
                
                // Mettre √† jour les placeholders dynamiques
                const searchInput = document.getElementById('searchInput');
                if (searchInput && window.languageManager) {
                    searchInput.placeholder = `üîç ${window.languageManager.t('searchReport')}`;
                }
            });
            
            console.log('=== INITIALISATION TERMIN√âE ===');
        });
    </script>
    
    <!-- Service Worker -->
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', function() {
                navigator.serviceWorker.register('service-worker.js')
                    .then(registration => console.log('SW registered'))
                    .catch(err => console.log('SW registration failed'));
            });
        }
    </script>
</body>
</html>