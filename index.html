<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rapports Commerciaux</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#2196F3">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>📋</text></svg>">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 400px;
            margin: 0 auto;
            padding: 20px;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* HEADER */
        .header {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 15px 20px;
            margin-bottom: 20px;
            display: none;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .user-info .avatar {
            width: 40px;
            height: 40px;
            background: #2196F3;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 14px;
        }

        .nav-buttons {
            display: flex;
            gap: 8px;
        }

        .nav-btn {
            padding: 8px 12px;
            border: none;
            border-radius: 8px;
            background: #2196F3;
            color: white;
            cursor: pointer;
            font-size: 11px;
            transition: all 0.3s ease;
            white-space: nowrap;
        }

        .nav-btn:hover {
            background: #1976D2;
            transform: translateY(-1px);
        }

        .nav-btn.active {
            background: #1976D2;
        }

        .nav-btn.logout {
            background: #f44336;
        }

        .nav-btn.logout:hover {
            background: #d32f2f;
        }

        /* PAGE CONTENT */
        .page {
            display: none;
            flex: 1;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }

        .page h1 {
            text-align: center;
            color: #333;
            margin-bottom: 30px;
            font-size: 24px;
        }

        /* LOGIN PAGE */
        .login-page {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
        }

        .logo {
            font-size: 60px;
            margin-bottom: 20px;
        }

        .form-group {
            width: 100%;
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #555;
            text-align: left;
        }

        .form-group input {
            width: 100%;
            padding: 15px;
            border: 2px solid #ddd;
            border-radius: 10px;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus {
            outline: none;
            border-color: #2196F3;
        }

        .login-btn {
            width: 100%;
            padding: 15px;
            background: #2196F3;
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .login-btn:hover:not(:disabled) {
            background: #1976D2;
            transform: translateY(-2px);
        }

        .login-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .error-message {
            color: #f44336;
            margin-top: 15px;
            padding: 10px;
            background: rgba(244, 67, 54, 0.1);
            border-radius: 8px;
            display: none;
            text-align: center;
        }

        .loading {
            color: #2196F3;
            margin-top: 15px;
            display: none;
            text-align: center;
        }

        /* RECORDING SECTION */
        .recording-section {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 30px;
            text-align: center;
        }

        .record-button {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            border: 4px solid white;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            font-size: 30px;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 15px auto;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .record-button:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.1);
        }

        .record-button.recording {
            background: #f44336;
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        .audio-controls {
            display: none;
            gap: 10px;
            justify-content: center;
            margin: 15px 0;
        }

        .audio-controls.show {
            display: flex;
        }

        .audio-btn {
            padding: 10px 20px;
            border: 2px solid white;
            background: transparent;
            color: white;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .audio-btn:hover {
            background: white;
            color: #667eea;
        }

        .send-btn {
            width: 100%;
            padding: 15px;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 15px;
            display: none;
        }

        .send-btn.show {
            display: block;
        }

        .send-btn:hover:not(:disabled) {
            background: #45a049;
            transform: translateY(-1px);
        }

        .send-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        /* REPORTS LIST */
        .reports-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .report-item {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 15px;
            transition: all 0.3s ease;
        }

        .report-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .report-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 10px;
        }

        .report-title {
            font-weight: bold;
            color: #333;
            font-size: 16px;
            flex: 1;
        }

        .report-date {
            color: #666;
            font-size: 12px;
            text-align: right;
            white-space: nowrap;
            margin-left: 10px;
        }

        .report-content {
            color: #555;
            line-height: 1.4;
            margin-bottom: 15px;
            max-height: 60px;
            overflow: hidden;
        }

        .report-actions {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .action-btn {
            padding: 6px 12px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 11px;
            transition: all 0.3s ease;
            white-space: nowrap;
        }

        .edit-btn {
            background: #2196F3;
            color: white;
        }

        .edit-btn:hover {
            background: #1976D2;
        }

        .validate-btn {
            background: #4CAF50;
            color: white;
        }

        .validate-btn:hover {
            background: #45a049;
        }

        .delete-btn {
            background: #f44336;
            color: white;
        }

        .delete-btn:hover {
            background: #d32f2f;
        }

        .view-btn {
            background: #FF9800;
            color: white;
        }

        .view-btn:hover {
            background: #F57C00;
        }

        .share-btn {
            background: #9C27B0;
            color: white;
        }

        .share-btn:hover {
            background: #7B1FA2;
        }

        .export-btn {
            background: #607D8B;
            color: white;
        }

        .export-btn:hover {
            background: #455A64;
        }

        /* SEARCH SECTION */
        .search-section {
            margin-bottom: 20px;
        }

        .search-input {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 10px;
            font-size: 14px;
        }

        .search-input:focus {
            outline: none;
            border-color: #2196F3;
        }

        /* EMPTY STATES */
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #666;
        }

        .empty-state .icon {
            font-size: 48px;
            margin-bottom: 15px;
        }

        /* RESPONSIVE */
        @media (max-width: 480px) {
            .container {
                padding: 15px;
            }
            
            .header {
                padding: 10px 15px;
            }
            
            .page {
                padding: 20px;
            }
            
            .report-actions {
                justify-content: center;
            }

            .nav-btn {
                padding: 6px 8px;
                font-size: 10px;
            }
        }

        /* Loading animation */
        .loading-spinner {
            border: 3px solid #f3f3f3;
            border-radius: 50%;
            border-top: 3px solid #2196F3;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            margin: 5px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Status indicators */
        .status-pending {
            background: #fff3cd;
            border-color: #ffeaa7;
            color: #856404;
        }

        .status-generating {
            background: #cce5ff;
            border-color: #99d6ff;
            color: #0056b3;
        }

        .status-error {
            background: #f8d7da;
            border-color: #f5c6cb;
            color: #721c24;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- HEADER (caché sur login) -->
        <div class="header" id="header">
            <div class="user-info">
                <div class="avatar" id="userAvatar">U</div>
                <div>
                    <div id="userName">Utilisateur</div>
                    <div style="font-size: 12px; color: #666;" id="userRole">Commercial</div>
                </div>
            </div>
            <div class="nav-buttons">
                <button class="nav-btn" id="navBrouillon">📝 Brouillons</button>
                <button class="nav-btn" id="navRapports">📊 Rapports</button>
                <button class="nav-btn logout" id="logoutBtn">🚪</button>
            </div>
        </div>

        <!-- MAIN CONTENT AREA -->
        <div id="mainContent">
            
            <!-- PAGE LOGIN -->
            <div class="page login-page" id="loginPage" style="display: block;">
                <div class="logo">🏢</div>
                <h1>Connexion</h1>
                <form id="loginForm">
                    <div class="form-group">
                        <label for="username">👤 Nom d'utilisateur</label>
                        <input type="text" id="username" name="username" required autocomplete="username">
                    </div>
                    <div class="form-group">
                        <label for="password">🔒 Mot de passe</label>
                        <input type="password" id="password" name="password" required autocomplete="current-password">
                    </div>
                    <button type="submit" class="login-btn" id="loginBtn">Se connecter</button>
                    <div class="error-message" id="errorMessage"></div>
                    <div class="loading" id="loadingMessage">
                        <div class="loading-spinner"></div>
                        Connexion en cours...
                    </div>
                </form>
            </div>

            <!-- PAGE BROUILLON -->
            <div class="page" id="brouillonPage" style="display: none;">
                <h1>📝 Brouillons</h1>
                
                <!-- Section Enregistrement -->
                <div class="recording-section">
                    <h3>🎤 Enregistrer un nouveau rapport</h3>
                    <div class="record-button" id="recordBtn">⏺️</div>
                    <div id="recordingStatus">Appuyer pour enregistrer</div>
                    
                    <div class="audio-controls" id="audioControls">
                        <button class="audio-btn" id="playBtn">▶️ Écouter</button>
                        <button class="audio-btn" id="reRecordBtn">🔄 Refaire</button>
                    </div>
                    
                    <button class="send-btn" id="sendAudioBtn">📤 Envoyer le vocal</button>
                </div>

                <!-- Liste des brouillons -->
                <div>
                    <h3>📋 Rapports en attente de validation :</h3>
                    <div class="reports-list" id="brouillonsList">
                        <div class="empty-state">
                            <div class="icon">📄</div>
                            <p>Aucun brouillon pour le moment</p>
                            <p style="font-size: 14px; margin-top: 10px;">Enregistrez votre premier rapport vocal !</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- PAGE RAPPORTS -->
            <div class="page" id="rapportsPage" style="display: none;">
                <h1>📊 Rapports finalisés</h1>
                
                <!-- Section Recherche -->
                <div class="search-section">
                    <input type="text" class="search-input" id="searchInput" placeholder="🔍 Rechercher un rapport...">
                </div>

                <!-- Stats -->
                <div style="text-align: center; margin-bottom: 20px; color: #666;">
                    ✅ Rapports validés : <span id="rapportsCount">0</span>
                </div>

                <!-- Liste des rapports -->
                <div class="reports-list" id="rapportsList">
                    <div class="empty-state">
                        <div class="icon">📋</div>
                        <p>Aucun rapport finalisé</p>
                        <p style="font-size: 14px; margin-top: 10px;">Validez vos brouillons pour les voir ici !</p>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <script>
        // Configuration globale
        const CONFIG = {
            N8N_WEBHOOK_URL: 'https://andreaprogra.app.n8n.cloud/webhook-test/88303112-848e-4b93-8758-5c2b16ecc52e',
            APP_VERSION: '1.0.0'
        };

        // Base de données utilisateurs locale
        const USERS_DB = [
            { 
                id: 1, 
                username: "commercial1", 
                password: "pass123", 
                nom: "Jean Dupont",
                deviceId: null,
                isActive: true,
                registeredAt: "2024-09-01T10:00:00Z"
            },
            { 
                id: 2, 
                username: "commercial2", 
                password: "pass456", 
                nom: "Marie Martin",
                deviceId: null,
                isActive: true,
                registeredAt: "2024-09-01T10:00:00Z"
            },
            { 
                id: 3, 
                username: "manager1", 
                password: "pass789", 
                nom: "Paul Durand",
                deviceId: null,
                isActive: true,
                registeredAt: "2024-09-01T10:00:00Z"
            }
        ];

        // Pages disponibles
        const PAGES = {
            LOGIN: 'loginPage',
            BROUILLON: 'brouillonPage',
            RAPPORTS: 'rapportsPage'
        };

        // Manager principal de l'application
        class AppManager {
            constructor() {
                this.currentUser = null;
                this.currentPage = PAGES.LOGIN;
                this.audioRecorder = null;
                this.recordedBlob = null;
                this.isRecording = false;
                this.audioStream = null;
                
                this.initializeApp();
                this.bindEvents();
            }

            // Génère un ID unique pour le téléphone
            generateDeviceId() {
                const screen = `${window.screen.width}x${window.screen.height}`;
                const timezone = Intl.DateTimeFormat().resolvedOptions().timeZone;
                const language = navigator.language;
                const platform = navigator.platform;
                const userAgent = navigator.userAgent.substring(0, 50);
                
                return btoa(`${screen}-${timezone}-${language}-${platform}-${userAgent}`);
            }

            // Initialisation de l'app
            initializeApp() {
                this.logout();
                this.showPage(PAGES.LOGIN);
            }

            // Charge les données depuis localStorage
            loadAppData() {
                try {
                    const saved = localStorage.getItem('rapportsApp');
                    if (saved) {
                        const data = JSON.parse(saved);
                        return {
                            brouillons: data.brouillons || [],
                            rapports: data.rapports || []
                        };
                    }
                } catch (error) {
                    console.error('Erreur lecture localStorage:', error);
                }
                return { brouillons: [], rapports: [] };
            }

            // Sauvegarde les données
            saveAppData(data) {
                try {
                    const dataToSave = {
                        ...data,
                        lastSaved: new Date().toISOString()
                    };
                    localStorage.setItem('rapportsApp', JSON.stringify(dataToSave));
                } catch (error) {
                    console.error('Erreur sauvegarde localStorage:', error);
                    // En cas d'erreur de quota, essayer de nettoyer les anciennes données
                    if (error.name === 'QuotaExceededError') {
                        console.log('Tentative de nettoyage automatique...');
                        this.cleanOldData(data);
                    }
                }
            }

            // Nettoie automatiquement les anciennes données
            cleanOldData(data) {
                try {
                    // Garde seulement les 10 derniers brouillons et 20 derniers rapports
                    const cleaned = {
                        brouillons: data.brouillons ? data.brouillons.slice(0, 10) : [],
                        rapports: data.rapports ? data.rapports.slice(0, 20) : [],
                        lastSaved: new Date().toISOString()
                    };
                    
                    localStorage.setItem('rapportsApp', JSON.stringify(cleaned));
                    console.log('Nettoyage automatique effectué');
                } catch (error) {
                    console.error('Erreur lors du nettoyage:', error);
                }
            }

            // Affichage des pages
            showPage(pageId) {
                // Masquer TOUTES les pages
                ['loginPage', 'brouillonPage', 'rapportsPage'].forEach(id => {
                    const page = document.getElementById(id);
                    if (page) page.style.display = 'none';
                });

                // Afficher SEULEMENT la page demandée
                if (pageId === 'loginPage' && !this.currentUser) {
                    const loginPage = document.getElementById('loginPage');
                    if (loginPage) loginPage.style.display = 'block';
                    const header = document.getElementById('header');
                    if (header) header.style.display = 'none';
                } else if (this.currentUser) {
                    const targetPage = document.getElementById(pageId);
                    if (targetPage) targetPage.style.display = 'block';
                    const header = document.getElementById('header');
                    if (header) header.style.display = 'flex';
                }

                this.currentPage = pageId;
                this.updateNavigation();
            }

            updateNavigation() {
                // Mise à jour des boutons de navigation
                document.querySelectorAll('.nav-btn').forEach(btn => {
                    btn.classList.remove('active');
                });

                if (this.currentPage === PAGES.BROUILLON) {
                    const navBrouillon = document.getElementById('navBrouillon');
                    if (navBrouillon) navBrouillon.classList.add('active');
                } else if (this.currentPage === PAGES.RAPPORTS) {
                    const navRapports = document.getElementById('navRapports');
                    if (navRapports) navRapports.classList.add('active');
                }
            }

            // Gestion des événements
            bindEvents() {
                // Login
                const loginForm = document.getElementById('loginForm');
                if (loginForm) {
                    loginForm.addEventListener('submit', (e) => {
                        e.preventDefault();
                        this.handleLogin();
                    });
                }

                // Navigation
                const navBrouillon = document.getElementById('navBrouillon');
                const navRapports = document.getElementById('navRapports');
                const logoutBtn = document.getElementById('logoutBtn');

                if (navBrouillon) {
                    navBrouillon.addEventListener('click', () => {
                        this.showPage(PAGES.BROUILLON);
                    });
                }

                if (navRapports) {
                    navRapports.addEventListener('click', () => {
                        this.showPage(PAGES.RAPPORTS);
                    });
                }

                if (logoutBtn) {
                    logoutBtn.addEventListener('click', () => {
                        this.logout();
                    });
                }

                // Audio recording
                const recordBtn = document.getElementById('recordBtn');
                const playBtn = document.getElementById('playBtn');
                const reRecordBtn = document.getElementById('reRecordBtn');
                const sendAudioBtn = document.getElementById('sendAudioBtn');

                if (recordBtn) {
                    recordBtn.addEventListener('click', () => {
                        this.toggleRecording();
                    });
                }

                if (playBtn) {
                    playBtn.addEventListener('click', () => {
                        this.playRecording();
                    });
                }

                if (reRecordBtn) {
                    reRecordBtn.addEventListener('click', () => {
                        this.resetRecording();
                    });
                }

                if (sendAudioBtn) {
                    sendAudioBtn.addEventListener('click', () => {
                        this.sendAudio();
                    });
                }

                // Search
                const searchInput = document.getElementById('searchInput');
                if (searchInput) {
                    searchInput.addEventListener('input', (e) => {
                        this.filterRapports(e.target.value);
                    });
                }
            }

            // Gestion du login
            async handleLogin() {
                const usernameEl = document.getElementById('username');
                const passwordEl = document.getElementById('password');
                const errorDiv = document.getElementById('errorMessage');
                const loadingDiv = document.getElementById('loadingMessage');
                const loginBtn = document.getElementById('loginBtn');

                if (!usernameEl || !passwordEl) return;

                const username = usernameEl.value.trim();
                const password = passwordEl.value.trim();

                // Validation basique
                if (!username || !password) {
                    this.showError('Veuillez remplir tous les champs');
                    return;
                }

                // Reset des messages
                if (errorDiv) errorDiv.style.display = 'none';
                if (loadingDiv) loadingDiv.style.display = 'block';
                if (loginBtn) loginBtn.disabled = true;

                try {
                    // Simulation délai réseau
                    await new Promise(resolve => setTimeout(resolve, 1000));

                    // Vérification utilisateur
                    const user = USERS_DB.find(u => u.username === username && u.password === password);
                    
                    if (!user) {
                        throw new Error('Identifiants incorrects');
                    }

                    if (!user.isActive) {
                        throw new Error('Compte désactivé. Contactez l\'administrateur.');
                    }

                    // Vérification Device ID
                    const deviceId = this.generateDeviceId();
                    
                    if (user.deviceId && user.deviceId !== deviceId) {
                        throw new Error(`Accès refusé - Ce compte est déjà lié à un autre appareil. Contactez l'administrateur.`);
                    }

                    // Premier login = enregistrement du device
                    if (!user.deviceId) {
                        user.deviceId = deviceId;
                        console.log(`Device enregistré pour ${username}: ${deviceId}`);
                    }

                    // Connexion réussie
                    this.currentUser = {
                        ...user,
                        loginTime: new Date().toISOString()
                    };

                    this.updateUserInterface();
                    this.loadUserData();
                    this.showPage(PAGES.BROUILLON);

                } catch (error) {
                    this.showError(error.message);
                } finally {
                    if (loadingDiv) loadingDiv.style.display = 'none';
                    if (loginBtn) loginBtn.disabled = false;
                }
            }

            showError(message) {
                const errorDiv = document.getElementById('errorMessage');
                if (errorDiv) {
                    errorDiv.textContent = message;
                    errorDiv.style.display = 'block';
                }
            }

            // Mise à jour de l'interface utilisateur
            updateUserInterface() {
                if (this.currentUser) {
                    const userNameEl = document.getElementById('userName');
                    const userAvatarEl = document.getElementById('userAvatar');
                    
                    if (userNameEl) userNameEl.textContent = this.currentUser.nom;
                    if (userAvatarEl) {
                        const initials = this.currentUser.nom.split(' ').map(n => n[0]).join('').substring(0, 2);
                        userAvatarEl.textContent = initials;
                    }
                }
            }

            // Chargement des données utilisateur
            loadUserData() {
                const saved = this.loadAppData();
                if (saved && saved.brouillons) {
                    this.updateBrouillonsList(saved.brouillons);
                }
                if (saved && saved.rapports) {
                    this.updateRapportsList(saved.rapports);
                }
            }

            // Déconnexion
            logout() {
                this.currentUser = null;
                this.resetRecording();
                
                // Reset du formulaire
                const loginForm = document.getElementById('loginForm');
                const errorMessage = document.getElementById('errorMessage');
                const loadingMessage = document.getElementById('loadingMessage');
                
                if (loginForm) loginForm.reset();
                if (errorMessage) errorMessage.style.display = 'none';
                if (loadingMessage) loadingMessage.style.display = 'none';
                
                this.showPage(PAGES.LOGIN);
            }

            // === GESTION AUDIO ===

            async toggleRecording() {
                if (this.isRecording) {
                    this.stopRecording();
                } else {
                    await this.startRecording();
                }
            }

            async startRecording() {
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ 
                        audio: {
                            echoCancellation: true,
                            noiseSuppression: true,
                            sampleRate: 44100
                        }
                    });
                    
                    this.audioStream = stream;

                    // Détection automatique du meilleur format supporté
                    let options = {};
                    
                    // Tests des formats par ordre de préférence
                    const formats = [
                        'audio/mp4',                    // Safari préféré
                        'audio/mp4;codecs=mp4a.40.2',  // Safari alternatif
                        'audio/webm;codecs=opus',       // Chrome/Firefox
                        'audio/webm',                   // Fallback WebM
                        'audio/ogg;codecs=opus',        // Firefox alternatif
                    ];
                    
                    let selectedFormat = null;
                    for (const format of formats) {
                        if (MediaRecorder.isTypeSupported(format)) {
                            selectedFormat = format;
                            options = { mimeType: format };
                            break;
                        }
                    }
                    
                    console.log('Format audio sélectionné:', selectedFormat || 'Défaut du navigateur');
                    
                    // Si aucun format spécifique n'est supporté, utilise les paramètres par défaut
                    this.audioRecorder = new MediaRecorder(stream, options);
                    this.audioChunks = [];

                    this.audioRecorder.ondataavailable = (event) => {
                        if (event.data.size > 0) {
                            this.audioChunks.push(event.data);
                        }
                    };

                    this.audioRecorder.onstop = () => {
                        // Utilise le type détecté ou un fallback
                        const blobType = selectedFormat || 'audio/wav';
                        this.recordedBlob = new Blob(this.audioChunks, { type: blobType });
                        
                        console.log('Blob créé:', this.recordedBlob.size, 'bytes, type:', blobType);
                        
                        this.updateRecordingUI(false);
                        this.stopAudioStream();
                    };

                    this.audioRecorder.start();
                    this.isRecording = true;
                    this.updateRecordingUI(true);
                    
                    console.log('Enregistrement démarré avec succès');

                } catch (error) {
                    console.error('Erreur microphone:', error);
                    
                    // Messages d'erreur plus spécifiques
                    let errorMessage = 'Erreur d\'accès au microphone: ';
                    if (error.name === 'NotAllowedError') {
                        errorMessage += 'Permission refusée. Autorisez l\'accès au microphone.';
                    } else if (error.name === 'NotFoundError') {
                        errorMessage += 'Aucun microphone détecté.';
                    } else if (error.name === 'NotSupportedError') {
                        errorMessage += 'Enregistrement audio non supporté par ce navigateur.';
                    } else {
                        errorMessage += error.message;
                    }
                    
                    alert(errorMessage);
                }
            }

            stopRecording() {
                if (this.audioRecorder && this.isRecording) {
                    this.audioRecorder.stop();
                    this.isRecording = false;
                }
            }

            stopAudioStream() {
                if (this.audioStream) {
                    this.audioStream.getTracks().forEach(track => track.stop());
                    this.audioStream = null;
                }
            }

            updateRecordingUI(recording) {
                const recordBtn = document.getElementById('recordBtn');
                const status = document.getElementById('recordingStatus');
                const controls = document.getElementById('audioControls');
                const sendBtn = document.getElementById('sendAudioBtn');

                if (!recordBtn || !status || !controls || !sendBtn) return;

                if (recording) {
                    recordBtn.textContent = '⏹️';
                    recordBtn.classList.add('recording');
                    status.textContent = '🔴 Enregistrement en cours...';
                    controls.classList.remove('show');
                    sendBtn.classList.remove('show');
                } else {
                    recordBtn.textContent = '⏺️';
                    recordBtn.classList.remove('recording');
                    status.textContent = '✅ Enregistrement terminé';
                    controls.classList.add('show');
                    sendBtn.classList.add('show');
                }
            }

            playRecording() {
                if (this.recordedBlob) {
                    const audioUrl = URL.createObjectURL(this.recordedBlob);
                    const audio = new Audio(audioUrl);
                    audio.play().catch(error => {
                        console.error('Erreur lecture audio:', error);
                    });
                    
                    audio.addEventListener('ended', () => {
                        URL.revokeObjectURL(audioUrl);
                    });
                }
            }

            resetRecording() {
                this.recordedBlob = null;
                this.isRecording = false;
                this.stopAudioStream();
                
                const recordBtn = document.getElementById('recordBtn');
                const status = document.getElementById('recordingStatus');
                const controls = document.getElementById('audioControls');
                const sendBtn = document.getElementById('sendAudioBtn');

                if (recordBtn) {
                    recordBtn.textContent = '⏺️';
                    recordBtn.classList.remove('recording');
                }
                if (status) status.textContent = 'Appuyer pour enregistrer';
                if (controls) controls.classList.remove('show');
                if (sendBtn) sendBtn.classList.remove('show');
            }

            async sendAudio() {
                if (!this.recordedBlob) {
                    console.log('Pas d\'audio enregistré');
                    return;
                }

                const sendBtn = document.getElementById('sendAudioBtn');
                if (sendBtn) {
                    sendBtn.disabled = true;
                    sendBtn.textContent = '📤 Envoi en cours...';
                }

                try {
                    console.log('=== DÉBUT ENVOI AUDIO ===');
                    console.log('Taille blob:', this.recordedBlob.size, 'bytes');
                    
                    const audioBase64 = await this.blobToBase64(this.recordedBlob);
                    console.log('Conversion base64 réussie, taille:', audioBase64.length, 'caractères');
                    
                    const brouillonId = 'brouillon_' + Date.now();
                    
                    // VERSION OPTIMISÉE : On ne stocke plus l'audio localement
                    const brouillon = {
                        id: brouillonId,
                        // audioFile: this.recordedBlob,     // ✅ SUPPRIMÉ pour économiser l'espace
                        // audioBase64: audioBase64,         // ✅ SUPPRIMÉ pour économiser l'espace
                        generatedReport: '',
                        isModified: false,
                        createdAt: new Date().toISOString(),
                        status: 'generating',
                        title: 'Génération en cours...'
                    };

                    this.addBrouillon(brouillon);
                    this.resetRecording();

                    console.log('Appel N8n...');
                    await this.callN8nWebhook(audioBase64, brouillonId);
                    console.log('=== ENVOI AUDIO TERMINÉ ===');

                } catch (error) {
                    console.error('Erreur dans sendAudio:', error);
                    alert('Erreur lors de l\'envoi: ' + error.message);
                } finally {
                    if (sendBtn) {
                        sendBtn.disabled = false;
                        sendBtn.textContent = '📤 Envoyer le vocal';
                    }
                }
            }

            async callN8nWebhook(audioBase64, brouillonId) {
                try {
                    console.log('=== APPEL N8N WEBHOOK ===');
                    const payload = {
                        audioData: audioBase64,
                        userId: this.currentUser.username,
                        timestamp: new Date().toISOString()
                    };

                    console.log('URL N8n:', CONFIG.N8N_WEBHOOK_URL);
                    console.log('Payload size:', JSON.stringify(payload).length, 'caractères');

                    const response = await fetch(CONFIG.N8N_WEBHOOK_URL, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(payload)
                    });

                    console.log('Response status:', response.status);
                    console.log('Response ok:', response.ok);

                    if (response.ok) {
                        const result = await response.json();
                        console.log('N8n success result:', result);
                        console.log('=== DEBUG RÉPONSE N8N ===', result);
                        console.log('result.content:', result.content);
                        console.log('result.title:', result.title);
                        console.log('Toutes les clés:', Object.keys(result));
                        
                        // Utilise le contenu reçu de N8n
                        this.updateBrouillonWithReport(brouillonId, result.content || result.title || 'Erreur: contenu non reçu de N8n');
                    } else {
                        const errorText = await response.text();
                        console.error('N8n HTTP error:', response.status, errorText);
                        throw new Error(`N8n HTTP ${response.status}: ${errorText}`);
                    }

                } catch (error) {
                    console.error('Exception dans callN8nWebhook:', error);
                    this.updateBrouillonStatus(brouillonId, 'error');
                    throw error;
                }
            }

            blobToBase64(blob) {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onloadend = () => {
                        const base64 = reader.result.split(',')[1];
                        resolve(base64);
                    };
                    reader.onerror = reject;
                    reader.readAsDataURL(blob);
                });
            }

            // === GESTION DES BROUILLONS ===

            getBrouillons() {
                const saved = this.loadAppData();
                return saved.brouillons || [];
            }

            addBrouillon(brouillon) {
                const saved = this.loadAppData();
                saved.brouillons = saved.brouillons || [];
                saved.brouillons.unshift(brouillon);
                
                this.saveAppData(saved);
                this.updateBrouillonsList(saved.brouillons);
            }

            updateBrouillonWithReport(brouillonId, reportContent) {
                const saved = this.loadAppData();
                const brouillon = saved.brouillons.find(b => b.id === brouillonId);
                
                if (brouillon) {
                    brouillon.generatedReport = reportContent;
                    brouillon.status = 'ready';
                    brouillon.title = 'Rapport généré - En attente de validation';
                    
                    this.saveAppData(saved);
                    this.updateBrouillonsList(saved.brouillons);
                }
            }

            updateBrouillonStatus(brouillonId, status) {
                const saved = this.loadAppData();
                const brouillon = saved.brouillons.find(b => b.id === brouillonId);
                
                if (brouillon) {
                    brouillon.status = status;
                    if (status === 'error') {
                        brouillon.title = 'Erreur lors de la génération';
                    }
                    
                    this.saveAppData(saved);
                    this.updateBrouillonsList(saved.brouillons);
                }
            }

            updateBrouillonsList(brouillons) {
                const container = document.getElementById('brouillonsList');
                if (!container) return;
                
                if (!brouillons || brouillons.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <div class="icon">📄</div>
                            <p>Aucun brouillon pour le moment</p>
                            <p style="font-size: 14px; margin-top: 10px;">Enregistrez votre premier rapport vocal !</p>
                        </div>
                    `;
                    return;
                }

                container.innerHTML = brouillons.map(brouillon => {
                    const date = new Date(brouillon.createdAt).toLocaleString();
                    let statusClass = '';
                    let statusIcon = '📄';
                    
                    if (brouillon.status === 'generating') {
                        statusClass = 'status-generating';
                        statusIcon = '⏳';
                    } else if (brouillon.status === 'error') {
                        statusClass = 'status-error';
                        statusIcon = '⚠️';
                    }

                    const content = brouillon.generatedReport || 'Génération en cours...';
                    const truncatedContent = content.length > 100 ? content.substring(0, 100) + '...' : content;

                    return `
                        <div class="report-item ${statusClass}">
                            <div class="report-header">
                                <div class="report-title">${statusIcon} ${brouillon.title || 'Nouveau rapport'}</div>
                                <div class="report-date">${date}</div>
                            </div>
                            <div class="report-content">${truncatedContent}</div>
                            <div class="report-actions">
                                ${brouillon.status === 'ready' ? `
                                    <button class="action-btn edit-btn" onclick="app.editBrouillon('${brouillon.id}')">✏️ Éditer</button>
                                    <button class="action-btn validate-btn" onclick="app.validateBrouillon('${brouillon.id}')">✅ Valider</button>
                                ` : ''}
                                ${brouillon.status === 'generating' ? `
                                    <div class="loading-spinner" style="display: inline-block; margin: 0;"></div>
                                ` : ''}
                                ${brouillon.status === 'error' ? `
                                    <button class="action-btn edit-btn" onclick="app.retryBrouillon('${brouillon.id}')">🔄 Réessayer</button>
                                ` : ''}
                                <button class="action-btn delete-btn" onclick="app.deleteBrouillon('${brouillon.id}')">🗑️ Supprimer</button>
                            </div>
                        </div>
                    `;
                }).join('');
            }

            // Édition complète des brouillons
            editBrouillon(brouillonId) {
                const saved = this.loadAppData();
                const brouillon = saved.brouillons.find(b => b.id === brouillonId);
                
                if (brouillon) {
                    const modal = document.createElement('div');
                    modal.innerHTML = `
                        <div style="
                            position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; 
                            background: rgba(0,0,0,0.8); z-index: 1000; 
                            display: flex; align-items: center; justify-content: center;
                            padding: 20px; box-sizing: border-box;
                        ">
                            <div style="
                                background: white; border-radius: 15px; 
                                max-width: 90vw; max-height: 90vh; 
                                display: flex; flex-direction: column;
                                overflow: hidden;
                            ">
                                <div style="padding: 20px; border-bottom: 1px solid #eee;">
                                    <h3>✏️ Éditer le rapport</h3>
                                </div>
                                <div style="padding: 20px; flex: 1; overflow-y: auto;">
                                    <label style="display: block; margin-bottom: 10px; font-weight: bold;">
                                        Titre du rapport:
                                    </label>
                                    <input type="text" id="editTitle" style="
                                        width: 100%; padding: 10px; border: 2px solid #ddd; 
                                        border-radius: 8px; margin-bottom: 20px; font-size: 16px;
                                    " value="${brouillon.title || 'Nouveau rapport'}">
                                    
                                    <label style="display: block; margin-bottom: 10px; font-weight: bold;">
                                        Contenu du rapport:
                                    </label>
                                    <textarea id="editContent" style="
                                        width: 100%; height: 300px; padding: 15px; 
                                        border: 2px solid #ddd; border-radius: 8px;
                                        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
                                        font-size: 14px; line-height: 1.5; resize: vertical;
                                    ">${brouillon.generatedReport}</textarea>
                                </div>
                                <div style="
                                    padding: 20px; border-top: 1px solid #eee;
                                    display: flex; gap: 10px; justify-content: flex-end;
                                ">
                                    <button onclick="this.closest('[data-modal]').remove()" style="
                                        padding: 12px 24px; border: 2px solid #ddd; 
                                        background: white; border-radius: 8px; cursor: pointer;
                                    ">Annuler</button>
                                    <button onclick="app.saveEditedBrouillon('${brouillonId}', this)" style="
                                        padding: 12px 24px; border: none; 
                                        background: #2196F3; color: white; border-radius: 8px; cursor: pointer;
                                    ">💾 Sauvegarder</button>
                                </div>
                            </div>
                        </div>
                    `;
                    modal.setAttribute('data-modal', 'true');
                    document.body.appendChild(modal);
                }
            }

            saveEditedBrouillon(brouillonId, buttonElement) {
                const modal = buttonElement.closest('[data-modal]');
                const newTitle = modal.querySelector('#editTitle').value.trim();
                const newContent = modal.querySelector('#editContent').value.trim();
                
                if (!newTitle || !newContent) {
                    alert('Veuillez remplir le titre et le contenu');
                    return;
                }
                
                const saved = this.loadAppData();
                const brouillon = saved.brouillons.find(b => b.id === brouillonId);
                
                if (brouillon) {
                    brouillon.title = newTitle;
                    brouillon.generatedReport = newContent;
                    brouillon.isModified = true;
                    
                    this.saveAppData(saved);
                    this.updateBrouillonsList(saved.brouillons);
                    
                    modal.remove();
                    alert('✅ Rapport modifié avec succès !');
                }
            }

            validateBrouillon(brouillonId) {
                if (!confirm('Valider ce rapport ? Il sera déplacé dans les rapports finalisés.')) {
                    return;
                }

                const saved = this.loadAppData();
                const brouillonIndex = saved.brouillons.findIndex(b => b.id === brouillonId);
                
                if (brouillonIndex !== -1) {
                    const brouillon = saved.brouillons[brouillonIndex];
                    
                    const rapport = {
                        id: 'rapport_' + Date.now(),
                        title: brouillon.title || `Rapport - ${new Date().toLocaleDateString()}`,
                        content: brouillon.generatedReport,
                        validatedAt: new Date().toISOString(),
                        createdAt: brouillon.createdAt,
                        sharedWith: [],
                        status: 'validated',
                        isModified: brouillon.isModified
                    };

                    saved.rapports = saved.rapports || [];
                    saved.rapports.unshift(rapport);
                    saved.brouillons.splice(brouillonIndex, 1);
                    
                    this.saveAppData(saved);
                    
                    this.updateBrouillonsList(saved.brouillons);
                    this.updateRapportsList(saved.rapports);
                    
                    alert('✅ Rapport validé avec succès !');
                }
            }

            deleteBrouillon(brouillonId) {
                if (!confirm('Supprimer définitivement ce brouillon ?')) {
                    return;
                }

                const saved = this.loadAppData();
                saved.brouillons = saved.brouillons.filter(b => b.id !== brouillonId);
                
                this.saveAppData(saved);
                this.updateBrouillonsList(saved.brouillons);
            }

            retryBrouillon(brouillonId) {
                alert('⚠️ Impossible de réessayer : l\'audio original n\'est plus disponible pour économiser l\'espace de stockage. Veuillez enregistrer un nouveau vocal.');
            }

            // === GESTION DES RAPPORTS FINALISÉS ===

            updateRapportsList(rapports) {
                const container = document.getElementById('rapportsList');
                const counter = document.getElementById('rapportsCount');
                
                if (counter) {
                    counter.textContent = rapports ? rapports.length : 0;
                }
                
                if (!container) return;
                
                if (!rapports || rapports.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <div class="icon">📋</div>
                            <p>Aucun rapport finalisé</p>
                            <p style="font-size: 14px; margin-top: 10px;">Validez vos brouillons pour les voir ici !</p>
                        </div>
                    `;
                    return;
                }

                container.innerHTML = rapports.map(rapport => {
                    const dateValidated = new Date(rapport.validatedAt).toLocaleDateString();
                    const truncatedContent = rapport.content.length > 150 ? 
                        rapport.content.substring(0, 150) + '...' : 
                        rapport.content;
                    
                    return `
                        <div class="report-item" style="cursor: pointer;" onclick="app.viewRapport('${rapport.id}')">
                            <div class="report-header">
                                <div class="report-title">📋 ${rapport.title}</div>
                                <div class="report-date">Validé le ${dateValidated}</div>
                            </div>
                            <div class="report-content">${truncatedContent}</div>
                            <div class="report-actions" style="margin-top: 10px;">
                                <button class="action-btn view-btn" onclick="event.stopPropagation(); app.viewRapport('${rapport.id}')">👁️ Voir complet</button>
                                <button class="action-btn share-btn" onclick="event.stopPropagation(); app.shareRapport('${rapport.id}')">📤 Partager</button>
                                <button class="action-btn export-btn" onclick="event.stopPropagation(); app.exportRapport('${rapport.id}')">💾 Exporter</button>
                            </div>
                        </div>
                    `;
                }).join('');
            }

            viewRapport(rapportId) {
                const saved = this.loadAppData();
                const rapport = saved.rapports.find(r => r.id === rapportId);
                
                if (rapport) {
                    const modal = document.createElement('div');
                    modal.innerHTML = `
                        <div style="
                            position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; 
                            background: rgba(0,0,0,0.8); z-index: 1000; 
                            display: flex; align-items: center; justify-content: center;
                            padding: 20px; box-sizing: border-box;
                        ">
                            <div style="
                                background: white; border-radius: 15px; 
                                max-width: 90vw; max-height: 90vh; 
                                display: flex; flex-direction: column;
                                overflow: hidden;
                            ">
                                <div style="
                                    padding: 20px; border-bottom: 1px solid #eee;
                                    display: flex; justify-content: space-between; align-items: center;
                                ">
                                    <h3>📋 ${rapport.title}</h3>
                                    <button onclick="this.closest('[data-modal]').remove()" style="
                                        background: none; border: none; font-size: 24px; cursor: pointer;
                                    ">×</button>
                                </div>
                                <div style="padding: 20px; flex: 1; overflow-y: auto;">
                                    <div style="
                                        background: #f8f9fa; padding: 10px; border-radius: 8px; 
                                        margin-bottom: 15px; font-size: 14px; color: #666;
                                    ">
                                        <strong>Validé le:</strong> ${new Date(rapport.validatedAt).toLocaleDateString()} à ${new Date(rapport.validatedAt).toLocaleTimeString()}
                                        ${rapport.isModified ? '<br><em>⚠️ Rapport modifié après génération</em>' : ''}
                                    </div>
                                    <div style="
                                        line-height: 1.6; font-size: 15px; white-space: pre-wrap;
                                    ">${rapport.content}</div>
                                </div>
                                <div style="
                                    padding: 20px; border-top: 1px solid #eee;
                                    display: flex; gap: 10px; justify-content: flex-end;
                                ">
                                    <button onclick="app.shareRapport('${rapport.id}'); this.closest('[data-modal]').remove();" style="
                                        padding: 12px 24px; border: 2px solid #9C27B0; 
                                        background: #9C27B0; color: white; border-radius: 8px; cursor: pointer;
                                    ">📤 Partager</button>
                                    <button onclick="this.closest('[data-modal]').remove()" style="
                                        padding: 12px 24px; border: 2px solid #ddd; 
                                        background: white; border-radius: 8px; cursor: pointer;
                                    ">Fermer</button>
                                </div>
                            </div>
                        </div>
                    `;
                    modal.setAttribute('data-modal', 'true');
                    document.body.appendChild(modal);
                }
            }

            shareRapport(rapportId) {
                const saved = this.loadAppData();
                const rapport = saved.rapports.find(r => r.id === rapportId);
                
                if (rapport && navigator.share) {
                    navigator.share({
                        title: rapport.title,
                        text: rapport.content
                    }).catch(err => console.log('Erreur partage:', err));
                } else if (rapport) {
                    navigator.clipboard.writeText(`${rapport.title}\n\n${rapport.content}`)
                        .then(() => alert('📋 Rapport copié dans le presse-papier'))
                        .catch(() => alert('Erreur lors de la copie'));
                }
            }

            exportRapport(rapportId) {
                const saved = this.loadAppData();
                const rapport = saved.rapports.find(r => r.id === rapportId);
                
                if (rapport) {
                    const textContent = `${rapport.title}\n\nValidé le: ${new Date(rapport.validatedAt).toLocaleDateString()}\n\n${rapport.content}`;
                    const blob = new Blob([textContent], { type: 'text/plain' });
                    const url = URL.createObjectURL(blob);
                    
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `${rapport.title.replace(/[^a-z0-9]/gi, '_')}.txt`;
                    a.click();
                    
                    URL.revokeObjectURL(url);
                }
            }

            filterRapports(searchTerm) {
                const saved = this.loadAppData();
                const rapports = saved.rapports || [];
                
                if (!searchTerm) {
                    this.updateRapportsList(rapports);
                    return;
                }

                const filtered = rapports.filter(rapport => 
                    rapport.title.toLowerCase().includes(searchTerm.toLowerCase()) ||
                    rapport.content.toLowerCase().includes(searchTerm.toLowerCase())
                );
                
                this.updateRapportsList(filtered);
            }
        }

        // Variable globale pour l'application
        let app;
        
        // Initialisation de l'application
        document.addEventListener('DOMContentLoaded', function() {
            app = new AppManager();
        });

        window.addEventListener('beforeunload', function() {
            if (app) {
                app.stopAudioStream();
            }
        });

        // Service Worker pour PWA
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', function() {
                navigator.serviceWorker.register('service-worker.js')
                    .then(function(registration) {
                        console.log('ServiceWorker registration successful');
                    })
                    .catch(function(err) {
                        console.log('ServiceWorker registration failed: ', err);
                    });
            });
        }
    </script>
</body>
</html>