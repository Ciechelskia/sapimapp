<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rapports Commerciaux</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#2196F3">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 400px;
            margin: 0 auto;
            padding: 20px;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 15px 20px;
            margin-bottom: 20px;
            display: none;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .avatar {
            width: 40px;
            height: 40px;
            background: #2196F3;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }

        .nav-btn {
            padding: 8px 12px;
            border: none;
            border-radius: 8px;
            background: #2196F3;
            color: white;
            cursor: pointer;
            font-size: 11px;
            margin-left: 5px;
        }

        .nav-btn.active { background: #1976D2; }
        .nav-btn.logout { background: #f44336; }

        .page {
            flex: 1;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
            display: none;
        }

        .page.show { display: block; }

        .page h1 {
            text-align: center;
            margin-bottom: 30px;
            font-size: 24px;
        }

        .login-form {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
        }

        .form-group {
            width: 100%;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
        }

        .form-group input {
            width: 100%;
            padding: 15px;
            border: 2px solid #ddd;
            border-radius: 10px;
            font-size: 16px;
        }

        .btn {
            width: 100%;
            padding: 15px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: #2196F3;
            color: white;
        }

        .btn-success {
            background: #4CAF50;
            color: white;
            display: none;
        }

        .btn-success.show { display: block; }

        .error {
            color: #f44336;
            text-align: center;
            margin-top: 10px;
            display: none;
        }

        .recording-section {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 30px;
            text-align: center;
        }

        .record-button {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            border: 4px solid white;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            font-size: 30px;
            cursor: pointer;
            margin: 15px auto;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .record-button.recording {
            background: #f44336;
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        .status {
            margin: 15px 0;
            font-weight: bold;
        }

        .reports-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .report-item {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 10px;
        }

        .report-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #666;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header" id="header">
            <div class="user-info">
                <div class="avatar" id="userAvatar">U</div>
                <div>
                    <div id="userName">Utilisateur</div>
                    <div style="font-size: 12px; color: #666;">Commercial</div>
                </div>
            </div>
            <div>
                <button class="nav-btn active" id="navBrouillon">Brouillons</button>
                <button class="nav-btn" id="navRapports">Rapports</button>
                <button class="nav-btn logout" id="logoutBtn">D√©connexion</button>
            </div>
        </div>

        <!-- Page Connexion -->
        <div class="page show" id="loginPage">
            <h1>üè¢ Connexion</h1>
            <form class="login-form" id="loginForm">
                <div class="form-group">
                    <label>Nom d'utilisateur</label>
                    <input type="text" id="username" value="commercial1" required>
                </div>
                <div class="form-group">
                    <label>Mot de passe</label>
                    <input type="password" id="password" value="pass123" required>
                </div>
                <button type="submit" class="btn btn-primary">Se connecter</button>
                <div class="error" id="errorMsg"></div>
            </form>
        </div>

        <!-- Page Brouillons -->
        <div class="page" id="brouillonPage">
            <h1>üìù Brouillons</h1>
            
            <div class="recording-section">
                <h3>üé§ Nouveau rapport</h3>
                <div class="record-button" id="recordBtn">‚è∫Ô∏è</div>
                <div class="status" id="recordStatus">Appuyez pour enregistrer</div>
                <button class="btn btn-success" id="sendBtn">üì§ Envoyer vers N8n</button>
            </div>

            <div>
                <h3>üìã En attente</h3>
                <div class="reports-list" id="brouillonsList">
                    <div class="empty-state">
                        <div style="font-size: 48px; margin-bottom: 15px;">üìÑ</div>
                        <p>Aucun brouillon</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Page Rapports -->
        <div class="page" id="rapportsPage">
            <h1>üìä Rapports finalis√©s</h1>
            <div class="reports-list" id="rapportsList">
                <div class="empty-state">
                    <div style="font-size: 48px; margin-bottom: 15px;">üìã</div>
                    <p>Aucun rapport finalis√©</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        const CONFIG = {
            N8N_URL: 'https://andreaprogra.app.n8n.cloud/webhook-test/488301f2-8446-4bd3-8758-5c2b6ecc52e'
        };

        const USERS = [
            { username: "commercial1", password: "pass123", nom: "Jean Dupont" }
        ];

        class App {
            constructor() {
                this.currentUser = null;
                this.audioRecorder = null;
                this.recordedBlob = null;
                this.isRecording = false;
                this.init();
            }

            init() {
                this.bindEvents();
                this.showLoginPage();
            }

            bindEvents() {
                document.getElementById('loginForm').addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.login();
                });

                document.getElementById('navBrouillon').addEventListener('click', () => {
                    this.showBrouillonPage();
                });

                document.getElementById('navRapports').addEventListener('click', () => {
                    this.showRapportsPage();
                });

                document.getElementById('logoutBtn').addEventListener('click', () => {
                    this.logout();
                });

                document.getElementById('recordBtn').addEventListener('click', () => {
                    this.toggleRecording();
                });

                document.getElementById('sendBtn').addEventListener('click', () => {
                    this.sendToN8n();
                });
            }

            showLoginPage() {
                console.log('Affichage page login');
                this.hideAllPages();
                document.getElementById('loginPage').classList.add('show');
                document.getElementById('header').style.display = 'none';
            }

            showBrouillonPage() {
                console.log('Affichage page brouillons');
                this.hideAllPages();
                document.getElementById('brouillonPage').classList.add('show');
                document.getElementById('header').style.display = 'flex';
                this.updateNav('navBrouillon');
            }

            showRapportsPage() {
                console.log('Affichage page rapports');
                this.hideAllPages();
                document.getElementById('rapportsPage').classList.add('show');
                document.getElementById('header').style.display = 'flex';
                this.updateNav('navRapports');
            }

            hideAllPages() {
                document.querySelectorAll('.page').forEach(page => {
                    page.classList.remove('show');
                });
            }

            updateNav(activeId) {
                document.querySelectorAll('.nav-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
                document.getElementById(activeId).classList.add('active');
            }

            login() {
                const username = document.getElementById('username').value;
                const password = document.getElementById('password').value;
                
                console.log('Tentative de connexion:', username);

                const user = USERS.find(u => u.username === username && u.password === password);
                
                if (user) {
                    this.currentUser = user;
                    document.getElementById('userName').textContent = user.nom;
                    document.getElementById('userAvatar').textContent = user.nom.substring(0, 2);
                    
                    console.log('Connexion r√©ussie, redirection vers brouillons');
                    this.showBrouillonPage();
                    
                } else {
                    document.getElementById('errorMsg').textContent = 'Identifiants incorrects';
                    document.getElementById('errorMsg').style.display = 'block';
                }
            }

            logout() {
                console.log('D√©connexion');
                this.currentUser = null;
                document.getElementById('loginForm').reset();
                document.getElementById('errorMsg').style.display = 'none';
                this.showLoginPage();
            }

            async toggleRecording() {
                if (this.isRecording) {
                    this.stopRecording();
                } else {
                    await this.startRecording();
                }
            }

            async startRecording() {
                try {
                    console.log('D√©marrage enregistrement');
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    
                    this.audioRecorder = new MediaRecorder(stream);
                    this.audioChunks = [];

                    this.audioRecorder.ondataavailable = (event) => {
                        this.audioChunks.push(event.data);
                    };

                    this.audioRecorder.onstop = () => {
                        this.recordedBlob = new Blob(this.audioChunks, { type: 'audio/webm' });
                        stream.getTracks().forEach(track => track.stop());
                        this.updateRecordingUI(false);
                    };

                    this.audioRecorder.start();
                    this.isRecording = true;
                    this.updateRecordingUI(true);

                } catch (error) {
                    console.error('Erreur microphone:', error);
                    alert('Erreur microphone: ' + error.message);
                }
            }

            stopRecording() {
                console.log('Arr√™t enregistrement');
                if (this.audioRecorder && this.isRecording) {
                    this.audioRecorder.stop();
                    this.isRecording = false;
                }
            }

            updateRecordingUI(recording) {
                const btn = document.getElementById('recordBtn');
                const status = document.getElementById('recordStatus');
                const sendBtn = document.getElementById('sendBtn');

                if (recording) {
                    btn.textContent = '‚èπÔ∏è';
                    btn.classList.add('recording');
                    status.textContent = 'üî¥ Enregistrement en cours...';
                    sendBtn.classList.remove('show');
                } else {
                    btn.textContent = '‚è∫Ô∏è';
                    btn.classList.remove('recording');
                    status.textContent = '‚úÖ Enregistrement termin√©';
                    sendBtn.classList.add('show');
                }
            }

            async sendToN8n() {
                if (!this.recordedBlob) return;

                console.log('=== ENVOI VERS N8N ===');
                
                const sendBtn = document.getElementById('sendBtn');
                sendBtn.disabled = true;
                sendBtn.textContent = 'üì§ Envoi...';

                try {
                    // Convertir en base64
                    const audioBase64 = await this.blobToBase64(this.recordedBlob);
                    console.log('Audio converti en base64, taille:', audioBase64.length);

                    const payload = {
                        audioData: audioBase64,
                        userId: this.currentUser.username,
                        timestamp: new Date().toISOString()
                    };

                    console.log('Payload pr√©par√©:', {
                        userId: payload.userId,
                        timestamp: payload.timestamp,
                        audioSize: payload.audioData.length
                    });

                    console.log('Appel vers:', CONFIG.N8N_URL);

                    // APPEL R√âEL VERS N8N
                    const response = await fetch(CONFIG.N8N_URL, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(payload)
                    });

                    console.log('R√©ponse N8n status:', response.status);
                    console.log('R√©ponse N8n headers:', [...response.headers.entries()]);

                    if (response.ok) {
                        const result = await response.json();
                        console.log('R√©ponse N8n body:', result);
                        
                        // Ajouter le rapport re√ßu √† la liste
                        this.addBrouillon(result);
                        
                        alert('‚úÖ Envoi r√©ussi ! Rapport g√©n√©r√© par N8n.');
                        
                    } else {
                        const errorText = await response.text();
                        console.error('Erreur N8n:', errorText);
                        alert('‚ùå Erreur N8n: ' + response.status + ' - ' + errorText);
                    }

                } catch (error) {
                    console.error('Erreur envoi:', error);
                    alert('‚ùå Erreur: ' + error.message);
                    
                } finally {
                    sendBtn.disabled = false;
                    sendBtn.textContent = 'üì§ Envoyer vers N8n';
                }
            }

            addBrouillon(data) {
                const brouillonsList = document.getElementById('brouillonsList');
                
                // Remplacer le contenu vide
                brouillonsList.innerHTML = `
                    <div class="report-item">
                        <div class="report-header">
                            <strong>üìã Rapport g√©n√©r√©</strong>
                            <small>${new Date().toLocaleString()}</small>
                        </div>
                        <div style="margin-top: 10px; color: #555;">
                            ${data.content ? data.content.substring(0, 150) + '...' : 'Contenu g√©n√©r√© par N8n'}
                        </div>
                    </div>
                `;
            }

            blobToBase64(blob) {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onloadend = () => resolve(reader.result.split(',')[1]);
                    reader.onerror = reject;
                    reader.readAsDataURL(blob);
                });
            }
        }

        // Initialisation
        const app = new App();

        // Service Worker
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('service-worker.js')
                .then(() => console.log('ServiceWorker OK'))
                .catch(err => console.log('ServiceWorker failed:', err));
        }
    </script>
</body>
</html>